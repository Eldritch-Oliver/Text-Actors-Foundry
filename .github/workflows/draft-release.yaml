name: Create Draft Release
on: [workflow_dispatch]
jobs:
  draft:
    runs-on: ubuntu-latest
    steps:
      # Checkout the repository
      - uses: actions/checkout@v4

      # Install node and NPM
      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      # Install required packages
      - run: npm install

      - name: Reading the system.json for the version
        id: "version"
        run: cat system.json | echo version=`jq -r ".version"` >> "$GITHUB_OUTPUT"

      # Check that tag doesn't exist
      - uses: mukunku/tag-exists-action@v1.5.0
        id: check-tag
        with:
          tag: "v${{ steps.version.outputs.version }}"

      - name: "Ensure that the tag doesn't exist"
        if: ${{ steps.check-tag.outputs.exists == 'true' }}
        run: exit 1

      # Compile the stuff that needs to be compiled
      - run: npm run build
      - run: node scripts/buildCompendia.mjs

      - name: Update the manifest with the relevant properties
        id: manifest-update
        uses: microsoft/variable-substitution@v1
        with:
          files: "system.json"
        env:
          download: "https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/release.zip"

      - name: Create the zip
        run: zip -r release.zip langs module styles templates system.json README.md assets

      - name: Create the draft release
        uses: ncipollo/release-action@v1
        with:
          tag: "v${{ steps.version.outputs.version }}"
          commit: ${{ github.ref }}
          draft: true
          body: <img aria-hidden="true" src="https://img.shields.io/github/downloads/${{ github.repository }}/v${{ steps.version.outputs.version }}/release.zip?style=flat-square&color=%2300aa00">
          generateReleaseNotes: true
          artifacts: "release.zip,system.json"
